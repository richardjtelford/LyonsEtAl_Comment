---
title: "Species assembly rules and data set size"
authors: "Richard J. Telford"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: html_document
bibliography: pairs.bib
csl: methods-in-ecology-and-evolution.csl
---

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=6, fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE, cache=TRUE)
library(ggplot2)
library(grid)
```

```{r importChunk}
source("pairs by dataset size functions.R")
#12
```

# Abstract



# Introduction

Analysis of presence-absence matrices to detect non-random species associations has a major, and contentions, research focus in community ecology and biogeograhy.

Description of Pairs and problems
fixed-fixed Null model, emprical Bayes using bins to reduce the number of false positives.
Von Gagern et al [-@Gagern2015] showed that Pairs [@Gotelli2010] classification of species-pairs as aggregated, segregated or random was dependent on the number of bins used.

In this paper, we explore the effect of the number of observations on the identification of aggregated and segregated species pairs by taking large presence-absence matricesa and by running Pairs [@Gotelli2010] on different sized subsets. 


# Methods

Reduced matrices were generated by taking a random subset of _n_ observations, where _n_ varied between 20 and the number of observations in the original data-set, with 10 replicates of each value of _n_. For each subset, _m_ species were selected at random, where _m_ was set to be small enough to guarantee there being enough species present even for the smallest reduced data-set. The reduced matrices were analyses with an R-implementation of Pairs [@Gotelli2010] by von Gagern et al [-@Gagern2015]. For each reduced matrix, we record the number of aggregated and segregated species pairs. All analyses were performed in R version 2.3.2 [@R2016].

## Data

# Results

# Discussion
```{r eval = FALSE, echo = FALSE}
Aggregated/segregated matrix plot
Aggregated/segregated plot by n

effect of N of nagg, nseg, pseg

Gotelli & Ulrich (2010 Oecologia
A major research focus in community ecology and biogeography has been the identification of non-random species associations in binary presence–absence matrices (Simberloff and Connor 1979; Gotelli and Graves 1996; Sfenthourakis et al. 2006). Gotelli & Ulrich (2010 Oecologia)
The analysis of the 272 published matrices revealed that the majority of significant species pairs showed segregated, rather than aggregated distributions. 
It is noteworthy that six of the 15 most aggregated matrices (40%) were for poikilotherm groups (snails, ostracods, and fish), whereas only two of the

15 most segregated matrices (13.3%) were for poikilotherms (Table 6). These results are consistent with matrix-wide patterns of species segregation (Gotelli and McCabe 2002), which were much stronger for homeotherms (and ant and plant matrices) than for poikilotherms (invertebrate, amphibian, reptile, and fish matrices). 
Perhaps it is asking too much of a statistical analysis to reveal biologically meaningful pairwise associations with no other information than a binary presence–absence matrix. A similar limitation has emerged in regression analyses and model selection. Whereas ecologists often use stepwise criteria to select a subset of meaningful predictor variables, these methods do not always identify the correct underlying model. A more powerful approach is to specify a priori a set of potential biological models, fit them to the data, and then use model selection criteria to rank them or distinguish between them (Burnham and Anderson 2002; Shipley 2002). For presence–absence matrices, the best strategy might be to identify ahead of time guilds or subsets of potentially interacting species and restrict the analysis to these pairs.

[Azeria et al Oecologia]
Identifying non-random species co-occurrence patterns (aggregated or segregated) is a central theme in ecology because patterns often reflect the existence of underlying mechanisms that structure community assembly (Diamond 1975; Connor and Simberloff 1979; Gotelli 2000). 

```

```{r loadDataChunk}
#SWAP
library(rioja)
data(SWAP)
 
#desert rodents
rodents<-read.table("http://academics.smcvt.edu/dmccabe/teaching/Community/matrices_ecosim/SWUSROD.TXT", header = TRUE, row.names = 1)
rodents<-as.data.frame(t(rodents))

#pollen 0K
pollen0<-read.csv("Blois_matrix_0.csv", row.names = 1)
pollen0<-as.data.frame(t(pollen0))

#pollen 1K
pollen1<-read.csv("Blois_matrix_1.csv", row.names = 1)
pollen1<-as.data.frame(t(pollen1))

#Holocene mammals
mammals<-read.table("LyonsHolocene.txt", row.names = 1, header = TRUE, sep="\t", comment = "")
mammals<-as.data.frame(t(mammals))

#Wisconsin understorey 1950
wisconsin<-read.table("WI_1950_u.txt", row.names = 1, header = TRUE)
wisconsin<-as.data.frame(t(wisconsin))
```

```{r SWAPpairsChunk, results='hide'}
SWAP.pairs <- runPairs(SWAP$spec)
SWAP.as <- aggseg(rrcs = SWAP.pairs$rrcs, sig = SWAP.pairs$sig)
```

```{r rodentPairsChunk, results='hide'}
rodent.pairs <- runPairs(rodents)
rodent.as <- aggseg(rrcs = rodent.pairs$rrcs, sig = rodent.pairs$sig)
```

```{r pollen0PairsChunk, results='hide'}
pollen0.pairs <- runPairs(pollen0)
pollen0.as <- aggseg(rrcs = pollen0.pairs$rrcs, sig = pollen0.pairs$sig)
```

```{r pollen1PairsChunk, results='hide'}
pollen1.pairs <- runPairs(pollen1)
pollen1.as <- aggseg(rrcs = pollen1.pairs$rrcs, sig = pollen1.pairs$sig)
```

```{r mammalsPairsChunk, results='hide'}
mammal.pairs <- runPairs(mammals)
mammal.as <- aggseg(rrcs = mammal.pairs$rrcs, sig = mammal.pairs$sig)
```

```{r wisconsinPairsChunk, results='hide'}
wisconsin.pairs <- runPairs(wisconsin)
wisconsin.as <- aggseg(rrcs = wisconsin.pairs$rrcs, sig = wisconsin.pairs$sig)
```



```{r plotChunk, fig.height=10}
vplayout <- function(x, y) viewport(layout.pos.row = x, layout.pos.col = y)

#SWAP
grid.newpage()
pushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(0.5, 5, 5, 5), "null"))))   
grid.text("MAIN TITLE", vp = vplayout(1, 1))
print(plot.uptri(SWAP.as) + ggtitle("SWAP"), vp = vplayout(2, 1))
print(plot.aggseg(SWAP.as, aggregated = FALSE), vp = vplayout(3, 1))
print(plot.aggseg(SWAP.as, aggregated = TRUE), vp = vplayout(4, 1))

#ghist <- ggplot(uptri(demo.as), aes(x = ki + kj, fill = aggseg)) + geom_histogram(show.legend = FALSE) +     colours3
#print(ghist

#Rodent
grid.newpage()
pushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(0.5, 5, 5, 5), "null"))))   
grid.text("Rodents", vp = vplayout(1, 1))
print(plot.uptri(rodent.as), vp = vplayout(2, 1))
print(plot.aggseg(rodent.as, aggregated = FALSE), vp = vplayout(3, 1))
print(plot.aggseg(rodent.as, aggregated = TRUE), vp = vplayout(4, 1))

#Pollen0
grid.newpage()
pushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(0.5, 5, 5, 5), "null"))))   
grid.text("Pollen 0K", vp = vplayout(1, 1))
print(plot.uptri(pollen0.as), vp = vplayout(2, 1))
print(plot.aggseg(pollen0.as, aggregated = FALSE), vp = vplayout(3, 1))
print(plot.aggseg(pollen0.as, aggregated = TRUE), vp = vplayout(4, 1))

#Pollen1
grid.newpage()
pushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(0.5, 5, 5, 5), "null"))))   
grid.text("Pollen 1K", vp = vplayout(1, 1))
print(plot.uptri(pollen1.as), vp = vplayout(2, 1))
print(plot.aggseg(pollen1.as, aggregated = FALSE), vp = vplayout(3, 1))
print(plot.aggseg(pollen1.as, aggregated = TRUE), vp = vplayout(4, 1))

#mammals
grid.newpage()
pushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(0.5, 5, 5, 5), "null"))))   
grid.text("Mammals", vp = vplayout(1, 1))
print(plot.uptri(mammal.as), vp = vplayout(2, 1))
print(plot.aggseg(mammal.as, aggregated = FALSE), vp = vplayout(3, 1))
print(plot.aggseg(mammal.as, aggregated = TRUE), vp = vplayout(4, 1))

#wisconsin
grid.newpage()
pushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(0.5, 5, 5, 5), "null"))))   
grid.text("Wisconsin 1950 Understorey", vp = vplayout(1, 1))
print(plot.uptri(wisconsin.as), vp = vplayout(2, 1))
print(plot.aggseg(wisconsin.as, aggregated = FALSE), vp = vplayout(3, 1))
print(plot.aggseg(wisconsin.as, aggregated = TRUE), vp = vplayout(4, 1))

```


```{r sigPairsChunk, eval = FALSE}

print.sigpairs<-function(x){
  print("Segregated Pairs")
  print(paste("n = ", nrow(x$data.seg)))
  print(x$data.seg[,3:6])
  print("")
  print("Aggregated Pairs")
  print(paste("n = ", nrow(x$data.agg)))
  print(x$data.agg[,3:6])
 invisible()
}
print("#### pollen 0K ####")
print.sigpairs(pollen0.pairs$sig)

print("Frequency segregated pairs")
print(table(as.character(unlist(pollen0.pairs$sig$data.seg[,3:4]))))
print("Rhizophora only occurs in 0K and 1K. Bursera occurs in 0K and 1K (and very rare in 10K). Cyrilla very rare except in 0K and 1K. Waltheria only in 0K and 1K")

print("#### pollen 1K ####")
print.sigpairs(pollen1.pairs$sig)
print(table(as.character(unlist(pollen1.pairs$sig$data.seg[,3:4]))))

print("#### Wisconsin 0K ####")
print.sigpairs(wisconsin.pairs$sig)

````

rank order curves/prop pairs <threshold
```{r rankOccupancyChunk}
rankOccupancy <- ldply(list("pollen0", "pollen1", "mammals", "wisconsin", "rodents"), function(x){
  dat <- get(x)
  occ <- sort(colSums(dat>0))
  data.frame(names = x, rank = 1:ncol(dat), occ = occ, socc = occ/nrow(dat))
})
print(ggplot(rankOccupancy,aes(rank, occ))+geom_point() + facet_wrap(~names, scales = "free"))
g<- ggplot(rankOccupancy,aes(rank, socc, colour = names))+geom_point() + labs(x = "Rank", y = "Scaled occupancy", colour  = "Data-set")
print(g)

```


```{r SWAPChunk, results = "hide", eval = TRUE}
#effect of dataset size
#SWAP
set.seed(3748)#from Random.org
SWAP.reduced<-reduced.count(spp = SWAP$spec)
```



```{r desertRodentChunk, eval = TRUE, results="hide"}
reduced.count.test(nsamp = rep(seq(20, 200, 20), each=10), spp = rodents)
set.seed(9515)
rodent.reduced<-reduced.count(nsamp = rep(seq(20, 200, 20), each=10), spp = rodents, nsp=18)

```


pollen0
```{r pollen0Chunk, eval = TRUE, results="hide"}
dim(pollen0)
reduced.count.test(nsamp = rep(seq(20, 250, 20), each=10), spp = pollen0)
set.seed(3236)
pollen0.reduced<-reduced.count(nsamp = rep(seq(20, 250, 20), each=10), spp = pollen0, nsp=40)

```


pollen1
```{r pollen1Chunk, eval = TRUE, results="hide", eval = TRUE}
dim(pollen1)
reduced.count.test(nsamp = rep(seq(20, 250, 20), each=10), spp = pollen1)
set.seed(3694)
pollen1.reduced<-reduced.count(nsamp = rep(c(seq(20, 200, 20), seq(240, 440, 40)), each=10), spp = pollen1, nsp=37)

```


Holocene mammals
```{r mammalsChunk, eval = TRUE, results="hide", eval = TRUE}
dim(mammals)
reduced.count.test(nsamp = rep(10, 50), spp = mammals)
set.seed(3367)
mammals.reduced<-reduced.count(nsamp = rep(c(10, 15, 20, seq(30, 214, 20)), each=10), spp = mammals, nsp=54)

```


Wisconsin 
```{r WisconsinUChunk, eval = TRUE, results="hide", eval = TRUE}
dim(wisconsin)
reduced.count.test(nsamp = rep(10, 100), spp = wisconsin)
set.seed(7625)
wisconsin.reduced<-reduced.count(nsamp = rep(c(10, 15, seq(20, 152, 15)), each=10), spp = wisconsin, nsp=105)

```





```{r combindedFigureChunk, fig.height= 10, fig.width = 7, eval = TRUE, cache = FALSE}
#need to move caption into figure (optionally remove), add a) etc to each plot
grid.newpage()

pushViewport(viewport(layout = grid.layout(5, 2)))
vplayout <- function(x, y) viewport(layout.pos.row = x, layout.pos.col = y)

print(plot.nagg(rodent.reduced)+ggtitle("a)") + theme(legend.position=c(0,1),legend.justification=c(0,1), legend.background = element_rect(fill="transparent")), vp = vplayout(1, 1))  # key is to define vplayout
print(plot.pagg(rodent.reduced)+ggtitle("b)"), vp = vplayout(1, 2))  

print(plot.nagg(pollen0.reduced)+ggtitle("c)"), vp = vplayout(2, 1))
print(plot.pagg(pollen0.reduced)+ggtitle("d)"), vp = vplayout(2, 2))  

print(plot.nagg(pollen1.reduced)+ggtitle("e)"), vp = vplayout(3, 1))
print(plot.pagg(pollen1.reduced)+ggtitle("f)"), vp = vplayout(3, 2))  

print(plot.nagg(wisconsin.reduced)+ggtitle("g)"), vp = vplayout(4, 1))
print(plot.pagg(wisconsin.reduced)+ggtitle("h)"), vp = vplayout(4, 2))  

print(plot.nagg(mammals.reduced)+ggtitle("i)"), vp = vplayout(5, 1))
print(plot.pagg(mammals.reduced)+ggtitle("j)"), vp = vplayout(5, 2)) 

#print(plot.nagg(SWAP.reduced)+ggtitle("k)"), vp = vplayout(6, 1))
#print(plot.pagg(SWAP.reduced)+ggtitle("l)"), vp = vplayout(6, 2))  

```


```{r newCombindedFigureChunk, fig.height= 6, fig.width = 6, eval = TRUE, cache = FALSE}
#need to move caption into figure (optionally remove), add a) etc to each plot
grid.newpage()

pushViewport(viewport(layout = grid.layout(2, 2)))
vplayout <- function(x, y) viewport(layout.pos.row = x, layout.pos.col = y)

print(plot.pagg(rodent.reduced)+ggtitle("a)"), vp = vplayout(1, 1))  
print(plot.pagg(mammals.reduced)+ggtitle("b)"), vp = vplayout(1, 2)) 
print(plot.pagg(pollen1.reduced)+ggtitle("c)"), vp = vplayout(2, 1))  
print(plot.pagg(wisconsin.reduced)+ggtitle("d)"), vp = vplayout(2, 2))  
```

```{r dumpDataChunk, eval = TRUE, cache=FALSE}
save(wisconsin.reduced, mammals.reduced, pollen0.reduced, pollen1.reduced, rodent.reduced, file = "reduced.rdata")
save(pollen0.pairs, pollen1.pairs, file = "pairs.rdata")

```

# References
